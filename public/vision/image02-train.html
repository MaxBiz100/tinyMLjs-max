<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Upload to Tensor</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
</head>
<body>
    <h6> Version 0.24.1</h6>
    <h1>Upload Images</h1>
    <label for="myLabels">Enter image labels (comma-separated), then click Choose Files</label>
    <input type="text" id="myLabels" size=80 value="1,1,2,2"> <br>
    <label for="myMinWidth">Enter model input width:</label>
    <input type="number" id="myMinWidth" value=96 style="width:50px"> px,

    <label for="myMinHeight">Enter model input height:</label>
    <input type="number" id="myMinHeight" value=96 style="width:50px"> px

    <br>

    <input type="file" id="myImageFile" accept="image/*" multiple>
    <br>

    <div id="myImagePreview" style="display:flex; flex-direction:row; flex-wrap:wrap; justify-content:center; padding:20px;"></div>
    <span id="mySpanSize">...</span><br>

    <input type="button" value="Convert Images to Tensor" onclick="loadImagesToTensor()">
    <input type="button" value="Train Model" onclick="trainModel()">
    <label for="myEpochs">Enter model input height:</label>
    <input type="number" id="myEpochs" value=100 style="width:50px"> loops,
    <input type="number" id="myLearningRate" value="0.0005" style="width:70px"> learning rate,
    <br>

    <input type="button" value="Export Model" onclick="exportModel()"> <input id="myExportFileName" type="text" value="my-model">
    <span id="mySpanExport">...</span>
    <hr>

    <label for="modelFile">Select model file:</label>
    <input type="file" id="modelFile" accept=".json">
    <br>
    <label for="weightsFile">Select weights file:</label>
    <input type="file" id="weightsFile" accept=".bin">
    <br>
    <input type="button" value="Upload Model" onclick="uploadModel()">
    <span id="mySpanUpload">...</span>


    <hr>


    <input type="button" value="Start Webcam" onclick="startWebcam()">
    <select id="mySelectWebcam" size="1">
        <option value="environment" selected="selected">Rear Camera</option>
        <option value="user">Front Camera</option>
    </select>
    <input type="button" value="Capture and Classify Image" onclick="classifyImage()">
    <span id="mySpanWebcam">...</span><br>
    <input type="button" value="Save Image" onclick="saveImage()"> <input id="myImageExportFileName" type="text"
                                                                          value="my-image.jpg"><br>
    <span id="mySpanCapture">...</span>


    <script>
        let myImageFiles = [];
        let labelsArray = [];
        let uniqueLabels = [];
        let labelsTensor;
        let myTensor;
        let minWidth;
        let minHeight;

        function updateLabels(index) {
            const label = prompt("Enter new label for image " + (index + 1) + ":");
            if (label !== null && label.trim() !== "") {
                labelsArray[index] = label.trim();
                previewImages();
            }
        }

        function previewImages() {
            const previewContainer = document.getElementById("myImagePreview");
            previewContainer.innerHTML = "";

            for (let i = 0; i < myImageFiles.length; i++) {
                const file = myImageFiles[i];
                const img = document.createElement("img");
                const label = labelsArray[i];
                img.src = URL.createObjectURL(file);
                img.style.width = "100px";
                img.style.height = "100px";
                img.style.objectFit = "cover";
                img.style.margin = "5px";
                img.style.border = "1px solid black";
                img.style.cursor = "pointer";
                img.onclick = () => updateLabels(i);
                const labelElement = document.createElement("span");
                labelElement.textContent = `Label: ${label}`;
                labelElement.style.marginTop = "5px";
                previewContainer.appendChild(img);
                previewContainer.appendChild(labelElement);
            }

            const spanSize = document.getElementById("mySpanSize");
            spanSize.textContent = `Preview Size: ${myImageFiles.length}`;
        }

        function imgToTensor(img) {
            return tf.tidy(() => {
                const tensor = tf.browser.fromPixels(img).toFloat();
                const resized = tf.image.resizeBilinear(tensor, [minWidth, minHeight]);
                const normalized = resized.div(tf.scalar(255));
                const batched = normalized.expandDims(0);
                return batched;
            });
        }

        function loadImagesToTensor() {
            const labelInput = document.getElementById("myLabels").value;
            labelsArray = labelInput.split(",").map(label => label.trim());
            uniqueLabels = Array.from(new Set(labelsArray));
            labelsTensor = tf.oneHot(labelsArray.map(label => uniqueLabels.indexOf(label)), uniqueLabels.length);

            const imageFileInput = document.getElementById("myImageFile");
            myImageFiles = imageFileInput.files;
            const minWidthInput = document.getElementById("myMinWidth").value;
            const minHeightInput = document.getElementById("myMinHeight").value;
            minWidth = parseInt(minWidthInput);
            minHeight = parseInt(minHeightInput);

            myTensor = [];
            for (let i = 0; i < myImageFiles.length; i++) {
                const file = myImageFiles[i];
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.createElement("img");
                    img.src = e.target.result;
                    img.onload = function () {
                        const tensor = imgToTensor(img);
                        myTensor.push(tensor);
                        if (myTensor.length === myImageFiles.length) {
                            previewImages();
                        }
                    };
                };
                reader.readAsDataURL(file);
            }
        }
    </script>
</body>
</html>
